<div class="ticket-card">
  <div class="form-header">
    <h1 class="form-title">Abrir un nuevo Ticket</h1>
    <p class="form-subtitle">Por favor, complete el siguiente formulario para crear un nuevo ticket.</p>
  </div>

  <form id="ticketForm" [formGroup]="ticketForm" (ngSubmit)="onSubmit()">

    <div *ngIf="!(isAuthenticated$ | async)">
      <div class="section-title">Información de Contacto</div>

      <div class="form-row">
        <div class="form-group">
          <label for="nombres">Nombres <span class="required">*</span></label>
          <input type="text" id="nombres" class="form-input" placeholder="Ingrese sus nombres" formControlName="nombres">
        </div>

        <div class="form-group">
          <label for="apellidos">Apellidos <span class="required">*</span></label>
          <input type="text" id="apellidos" class="form-input" placeholder="Ingrese sus apellidos" formControlName="apellidos">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dni">DNI <span class="required">*</span></label>
          <input type="text" id="dni" class="form-input" placeholder="12345678" formControlName="dni">
        </div>

        <div class="form-group">
          <label for="telefono">Teléfono Móvil <span class="required">*</span></label>
          <input type="tel" id="telefono" class="form-input" placeholder="+51 999 999 999" formControlName="telefono">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="codigoAlumno">Código de Alumno <span class="required">*</span></label>
          <input type="text" id="codigoAlumno" class="form-input" placeholder="A12345678" formControlName="codigoAlumno">
        </div>

        <div class="form-group">
          <label for="sede">Sede <span class="required">*</span></label>
          <select id="sede" class="form-select" formControlName="sede">
            <option value="">— Seleccionar —</option>
            <option *ngFor="let sede of sedes" [value]="sede.id">{{ sede.nombre }}</option>
          </select>

          <small *ngIf="sedes.length === 0" class="text-muted">
            No hay sedes disponibles
          </small>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Correo electrónico activo <span class="required">*</span></label>
        <div class="email-row">
          <input type="email" id="email" class="form-input" placeholder="ejemplo@correo.com" formControlName="email">
          <button type="button" class="btn btn-secondary" (click)="enviarCodigo()" [disabled]="!ticketForm.get('email')?.valid">
            Enviar código
          </button>
        </div>
        <small *ngIf="mostrarCodigo" style="color:#007bff; cursor:pointer;" (click)="permitirEditarCorreo()">
          ¿Te equivocaste de correo?
        </small>
      </div>

      <div class="form-group" *ngIf="mostrarCodigo">
        <label for="codigoValidacion">Código de validación</label>
        <div class="email-row">
          <input type="text" id="codigoValidacion" class="form-input" maxlength="6" placeholder="Ingresa el código recibido"
            formControlName="codigoValidacion">
          <button type="button" class="btn btn-secondary" (click)="validarCodigo()"
            [disabled]="!ticketForm.get('codigoValidacion')?.valid || correoVerificado">
            Validar código
          </button>
        </div>
        <small *ngIf="ticketForm.get('codigoValidacion')?.invalid && ticketForm.get('codigoValidacion')?.touched" style="color:red;">
          El código debe tener 6 dígitos numéricos
        </small>
      </div>
    </div>

    <div class="section-title">Temas de ayuda</div>

    <div class="form-group full-width">
      <label for="categoria">Seleccione un tema de ayuda <span class="required">*</span></label>
      <select id="categoria" class="form-select categoria-jerarquica" formControlName="categoria">
        <option value="">— Seleccione un tema de ayuda —</option>
        <option 
          *ngFor="let categoria of categoriasPlanas" 
          [value]="categoria.id"
          [disabled]="categoria.disabled"
          [class.categoria-padre-option]="categoria.esPadre"
          [class.categoria-hija-option]="!categoria.esPadre">
          {{ categoria.indentacion }}{{ categoria.nombre }}
        </option>
      </select>

      <small class="text-muted categoria-hint">
        <i class="bi bi-info-circle me-1"></i>
        Las categorías en <strong>negrita</strong> son principales. Selecciona una subcategoría específica.
      </small>

      <small *ngIf="categoriasPlanas.length === 0 && !isLoading" class="text-danger">
        No hay categorías disponibles
      </small>

      <small *ngIf="isLoading" class="text-muted">
        Cargando categorías...
      </small>
    </div>

    <div *ngIf="ticketForm.get('categoria')?.value" class="form-group full-width">
      <label for="asunto">Asunto <span class="required">*</span></label>
      <input type="text" id="asunto" class="form-input" placeholder="Ingrese el asunto" formControlName="asunto">
    </div>

    <div *ngIf="ticketForm.get('categoria')?.value" class="form-group full-width">
      <label for="comentarios">Comentarios / Detalles <span class="required">*</span></label>
      <textarea id="comentarios" class="form-input" rows="5" placeholder="Escriba aquí los detalles de su consulta"
        formControlName="comentarios"></textarea>
    </div>

    <div class="button-group">
      <button type="submit" class="btn btn-primary" id="createBtn">Crear Ticket</button>
      <button type="reset" class="btn btn-secondary" id="resetBtn" (click)="onReset()">Restablecer</button>
      <button type="button" class="btn btn-outline" id="cancelBtn" (click)="onCancel()">Cancelar</button>
    </div>
  </form>
</div>
